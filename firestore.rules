
/**
 * This ruleset enforces a security model with two distinct patterns:
 * 1. A strict user-ownership model for all user-specific data.
 * 2. A public read-only model for global, shared content.
 *
 * Core Philosophy:
 * By default, all access is denied. Rules then grant specific permissions. The primary goal is to ensure users can only access and modify their own information, preventing data leaks or unauthorized modifications between users.
 *
 * Data Structure:
 * - /users/{userId}: The root for all data owned by a single user.
 *   - /users/{userId}/favorites: A user's private list of favorited quotes.
 *   - /users/{userId}/recentlyViewed: A user's private history of viewed quotes.
 *   - /users/{userId}/appSettings: A user's private application settings.
 * - /quotes: A top-level collection of all quotes, considered public data.
 * - /themes: A top-level collection of all themes, considered public data.
 *
 * Key Security Decisions:
 * - User Isolation: A user can only access documents within their own data tree (i.e., under /users/{their-own-userId}). They cannot read or write to another user's tree.
 * - No User Enumeration: Listing the entire /users collection is disallowed to protect user privacy.
 * - Public Content is Read-Only: The global /quotes and /themes collections are readable by anyone but cannot be modified by clients. This prevents vandalism and assumes content is managed through a trusted backend process or admin panel.
 * - Authorization-Critical Fields: On creation, documents inside a user's tree (e.g., a 'favorite') MUST contain a `userId` field that correctly matches the authenticated user. This field is enforced as immutable to prevent re-associating the document with a different user.
 *
 * Denormalization for Authorization:
 * The `Favorite`, `RecentlyViewed`, and `AppSetting` documents each contain a denormalized `userId` field. This is critical for efficient and secure rule enforcement, as it allows rules to validate ownership on creation and updates without needing costly `get()` calls to parent documents.
 *
 * Structural Segregation:
 * The separation of private user data (under /users) and public global data (under /quotes and /themes) is a core design principle. This segregation simplifies security rules, improves query performance, and makes it impossible for a query to accidentally leak private data from a public collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if a document already exists and the requester is the owner.
     * CRITICAL for safe update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates that the user's root document has an 'id' field
     * matching the user's UID upon creation.
     */
    function isCreatingSelf(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates that a new document in a user's subcollection has a 'userId'
     * field that correctly links it back to the owner.
     */
    function hasCorrectOwnerField(userId) {
      return request.resource.data.userId == userId;
    }
    
    /**
     * Validates that a field is unchanged during an update operation.
     * Essential for protecting ownership and relational keys.
     */
    function isImmutable(field) {
        return request.resource.data[field] == resource.data[field];
    }


    // ----------------------------------------------------------------------
    // Collection Rules
    // ----------------------------------------------------------------------

    /**
     * @description Manages user profile documents. Each user has one document, identified by their UID.
     * @path /users/{userId}
     * @allow A user (uid: 'user123') creates their own profile document at /users/user123. (create)
     * @deny A user (uid: 'user123') tries to read another user's profile at /users/user456. (get)
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isCreatingSelf(userId);
      allow update: if isExistingOwner(userId) && isImmutable('id');
      allow delete: if isExistingOwner(userId);

      /**
       * @description User's private collection of favorited quotes.
       * @path /users/{userId}/favorites/{favoriteId}
       * @allow A user (uid: 'user123') creates a new favorite record for themselves. (create)
       * @deny An anonymous user tries to list favorites. (list)
       * @principle Enforces strict ownership for all reads and writes.
       */
      match /favorites/{favoriteId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasCorrectOwnerField(userId);
        allow update: if isExistingOwner(userId) && isImmutable('userId');
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description User's private history of recently viewed quotes.
       * @path /users/{userId}/recentlyViewed/{recentlyViewedId}
       * @allow A user (uid: 'user123') reads their own recently viewed list. (get, list)
       * @deny A user (uid: 'user123') tries to delete another user's history item. (delete)
       * @principle Enforces strict ownership for all reads and writes.
       */
      match /recentlyViewed/{recentlyViewedId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasCorrectOwnerField(userId);
        allow update: if isExistingOwner(userId) && isImmutable('userId');
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description User-specific application settings.
       * @path /users/{userId}/appSettings/{appSettingId}
       * @allow A user (uid: 'user123') updates their own notification settings. (update)
       * @deny A user (uid: 'user123') tries to create settings for another user. (create)
       * @principle Enforces strict ownership for all reads and writes.
       */
      match /appSettings/{appSettingId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) && hasCorrectOwnerField(userId);
        allow update: if isExistingOwner(userId) && isImmutable('userId');
        allow delete: if isExistingOwner(userId);
      }
    }

    /**
     * @description Stores all quotes. This is public, read-only content.
     * @path /quotes/{quoteId}
     * @allow Any user, signed-in or not, can read any quote document. (get, list)
     * @deny Any signed-in user attempts to modify or delete a quote. (create, update, delete)
     * @principle Secures global content by making it read-only for clients, preventing vandalism. Content is assumed to be managed by a trusted backend.
     */
    match /quotes/{quoteId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores all themes/categories for quotes. This is public, read-only content.
     * @path /themes/{themeId}
     * @allow Any user, signed-in or not, can read any theme document. (get, list)
     * @deny Any signed-in user attempts to create a new theme. (create)
     * @principle Secures global content by making it read-only for clients, preventing vandalism. Content is assumed to be managed by a trusted backend.
     */
    match /themes/{themeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}
